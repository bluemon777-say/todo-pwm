<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë‹¬ë ¥ í• ì¼</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; }
    body { margin: 0; background: #f6f7fb; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; } /* âœ… í­ ë” í¬ê²Œ */

    /* Top */
    .topbar { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 12px; }
    .title { font-size: 18px; font-weight: 800; }
    .nav { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

    button {
      border: 0; border-radius: 12px; padding: 10px 12px; font-size: 14px; cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,.08); touch-action: manipulation;
      background: #111827; color: #fff;
    }
    button.secondary { background: #e5e7eb; color: #111827; }

    .card { background: #fff; border-radius: 16px; padding: 14px; box-shadow: 0 8px 20px rgba(0,0,0,.06); }

    /* Calendar */
    .dow { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0; margin: 8px 0; } /* âœ… ê°„ê²© 0 */
    .dow div { text-align: center; font-size: 12px; color: #6b7280; padding: 6px 0; }
    .dow .sunHead { color: #ef4444; font-weight: 800; }
    .dow .satHead { color: #2563eb; font-weight: 800; }

    .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0; } /* âœ… ê°„ê²© 0 */
    .cell {
      background: #fff;
      border: 1px solid #eef0f4;
      border-radius: 0;                 /* âœ… ì‚¬ê° */
      padding: 12px 10px;
      min-height: 82px;                 /* âœ… ì¡°ê¸ˆ ë” í¬ê²Œ */
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      box-shadow: none;                 /* âœ… ë¶™ì–´ë³´ì´ê²Œ */
      user-select: none;
    }
    .cell.muted { opacity: .45; }
    .cell.selected { outline: 2px solid #111827; outline-offset: -2px; }

    .daynum {
      font-size: 14px; font-weight: 800;
      display: flex; justify-content: space-between; align-items: center;
      line-height: 1;
    }

    /* âœ… í† /ì¼ ìˆ«ì ìƒ‰ */
    .sunNum { color: #ef4444; font-weight: 900; }
    .satNum { color: #2563eb; font-weight: 900; }

    /* âœ… ê³µíœ´ì¼ ìŠ¤íƒ€ì¼ */
    .holidayCell { background: #fff5f5; border-color: #ffd7d7; }
    .holidayNum { color: #ef4444; font-weight: 900; }

    .holidayLine {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      min-height: 14px;
    }
    .holidayName {
      font-size: 11px;
      color: #ef4444;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.1;
      flex: 1;
      min-width: 0;
    }
    .subTag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
      font-weight: 800;
      white-space: nowrap;
    }

    .badge { font-size: 11px; padding: 2px 8px; border-radius: 999px; background: #111827; color: #fff; }
    .todayDot { width: 8px; height: 8px; border-radius: 999px; background: #ef4444; display: inline-block; margin-left: 6px; }

    /* Todo panel */
    .panel { margin-top: 12px; }
    .panelHeader { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .panelTitle { font-size: 16px; font-weight: 900; }
    .meta { margin-top: 6px; font-size: 12px; color: #6b7280; }
    .meta .holidayTag { color: #ef4444; font-weight: 900; margin-left: 6px; }

    .row { display: flex; gap: 10px; margin-top: 12px; }
    input[type="text"]{
      flex: 1; border: 1px solid #e5e7eb; border-radius: 12px;
      padding: 12px; font-size: 16px; outline: none;
    }
    .add { min-width: 86px; }

    ul { list-style: none; padding: 0; margin: 12px 0 0; display: flex; flex-direction: column; gap: 10px; }
    li {
      background: #fff; border-radius: 14px; padding: 12px; border: 1px solid #eef0f4;
      display: flex; justify-content: space-between; gap: 10px; align-items: center;
    }
    .left { display: flex; gap: 10px; align-items: flex-start; flex: 1; min-width: 0; }
    .check { transform: scale(1.15); margin-top: 2px; }
    .txt { white-space: pre-wrap; word-break: break-word; line-height: 1.3; font-size: 16px; }
    .done .txt { text-decoration: line-through; color: #9ca3af; }
    .del { background: #ef4444; color: #fff; }
    .empty { padding: 14px 2px; color: #9ca3af; font-size: 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title" id="monthTitle">ğŸ“…</div>
      <div class="nav">
        <button class="secondary" id="prevBtn">ì´ì „</button>
        <button class="secondary" id="todayBtn">ì˜¤ëŠ˜</button>
        <button class="secondary" id="nextBtn">ë‹¤ìŒ</button>
      </div>
    </div>

    <div class="card">
      <div class="dow">
        <div class="sunHead">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="satHead">í† </div>
      </div>
      <div class="grid" id="calGrid"></div>
    </div>

    <div class="card panel">
      <div class="panelHeader">
        <div>
          <div class="panelTitle" id="selectedTitle">ì„ íƒí•œ ë‚ ì§œ</div>
          <div class="meta" id="selectedMeta"></div>
        </div>
        <button class="secondary" id="clearDoneBtn">ì™„ë£Œì‚­ì œ</button>
      </div>

      <div class="row">
        <input id="todoInput" type="text" placeholder="ì„ íƒí•œ ë‚ ì§œì— í•  ì¼ì„ ì¶”ê°€" autocomplete="off" />
        <button class="add" id="addBtn">ì¶”ê°€</button>
      </div>

      <ul id="todoList"></ul>
      <div class="empty" id="todoEmpty" style="display:none;">ì´ ë‚ ì§œì—ëŠ” í•  ì¼ì´ ì—†ì–´ìš” ğŸ™‚</div>
    </div>
  </div>

  <script>
    // ===== Todo Storage Model =====
    // { "YYYY-MM-DD": [ {id, text, done, createdAt} , ... ], ... }
    const TODO_KEY = "calendar_todo_v1";

    // ===== Holiday Source (KR) =====
    // GET https://date.nager.at/api/v3/PublicHolidays/{year}/KR
    const HOLI_CACHE_KEY = "kr_holidays_cache_v1"; // { holidayByYear: { [year]: { [dateKey]: {name,isSub} } }, meta: { [year]: {fetchedAt} } }
    const HOLI_TTL_MS = 1000 * 60 * 60 * 24 * 30; // 30ì¼

    const $monthTitle = document.getElementById("monthTitle");
    const $calGrid = document.getElementById("calGrid");
    const $prevBtn = document.getElementById("prevBtn");
    const $nextBtn = document.getElementById("nextBtn");
    const $todayBtn = document.getElementById("todayBtn");

    const $selectedTitle = document.getElementById("selectedTitle");
    const $selectedMeta = document.getElementById("selectedMeta");
    const $todoInput = document.getElementById("todoInput");
    const $addBtn = document.getElementById("addBtn");
    const $todoList = document.getElementById("todoList");
    const $todoEmpty = document.getElementById("todoEmpty");
    const $clearDoneBtn = document.getElementById("clearDoneBtn");

    // Todos
    let todoData = {}; // dateKey -> todos[]

    // Holidays
    let holidayByYear = {}; // year -> { dateKey -> {name,isSub} }
    let holidayCacheMeta = {}; // year -> { fetchedAt }

    const today = new Date();
    let viewYear = today.getFullYear();
    let viewMonth = today.getMonth(); // 0-11
    let selectedDateKey = toKey(today);

    function pad2(n){ return String(n).padStart(2, "0"); }
    function toKey(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function fromKey(key){
      const [y,m,d] = key.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    // ===== Todos load/save =====
    function todoLoad(){
      try{
        const raw = localStorage.getItem(TODO_KEY);
        const parsed = raw ? JSON.parse(raw) : {};
        todoData = (parsed && typeof parsed === "object") ? parsed : {};
      } catch {
        todoData = {};
      }
    }
    function todoSave(){
      localStorage.setItem(TODO_KEY, JSON.stringify(todoData));
    }
    function getTodos(dateKey){
      const arr = todoData[dateKey];
      return Array.isArray(arr) ? arr : [];
    }
    function setTodos(dateKey, todos){
      todoData[dateKey] = todos;
      todoSave();
    }
    function countTodos(dateKey){
      return getTodos(dateKey).length;
    }

    // ===== Holiday cache load/save =====
    function holidayLoadCache(){
      try{
        const raw = localStorage.getItem(HOLI_CACHE_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if(parsed && typeof parsed === "object"){
          holidayByYear = parsed.holidayByYear || {};
          holidayCacheMeta = parsed.meta || {};
        } else {
          holidayByYear = {};
          holidayCacheMeta = {};
        }
      } catch {
        holidayByYear = {};
        holidayCacheMeta = {};
      }
    }
    function holidaySaveCache(){
      localStorage.setItem(HOLI_CACHE_KEY, JSON.stringify({
        holidayByYear,
        meta: holidayCacheMeta
      }));
    }

    function getHolidayObj(dateKey){
      const y = Number(dateKey.slice(0,4));
      return (holidayByYear[y] && holidayByYear[y][dateKey]) ? holidayByYear[y][dateKey] : null;
    }
    function getHolidayName(dateKey){
      const o = getHolidayObj(dateKey);
      return o ? o.name : "";
    }
    function isHoliday(dateKey){
      return !!getHolidayName(dateKey);
    }
    function isSubHoliday(dateKey){
      const o = getHolidayObj(dateKey);
      return !!(o && o.isSub);
    }

    function detectSubstitute(name){
      const n = (name || "").toLowerCase();
      // âœ… "ëŒ€ì²´ê³µíœ´ì¼", "ëŒ€ì²´ íœ´ì¼", "substitute" ë“± ê°ì§€
      return (name.includes("ëŒ€ì²´") || n.includes("substitute"));
    }

    async function ensureHolidaysForYear(year){
      const meta = holidayCacheMeta[year];
      if(holidayByYear[year] && meta && (Date.now() - meta.fetchedAt) < HOLI_TTL_MS){
        return;
      }
      try{
        const url = `https://date.nager.at/api/v3/PublicHolidays/${year}/KR`;
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error(`holiday fetch failed: ${res.status}`);
        const arr = await res.json();

        const map = {};
        for(const h of arr){
          const dateKey = h.date; // "YYYY-MM-DD"
          const name = (h.localName || h.name || "").trim();
          if(dateKey && name){
            map[dateKey] = { name, isSub: detectSubstitute(name) };
          }
        }

        holidayByYear[year] = map;
        holidayCacheMeta[year] = { fetchedAt: Date.now() };
        holidaySaveCache();
      } catch (e){
        console.log(e);
      }
    }

    function renderMonthTitle(){
      $monthTitle.textContent = `ğŸ“… ${viewYear}-${pad2(viewMonth+1)}`;
    }

    function renderCalendar(){
      renderMonthTitle();
      $calGrid.innerHTML = "";

      // âœ… 7*5 = 35ì¹¸ ê³ ì •
      const first = new Date(viewYear, viewMonth, 1);
      const firstDow = first.getDay(); // 0 Sun
      const start = new Date(viewYear, viewMonth, 1 - firstDow);

      for(let i=0;i<35;i++){
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const inMonth = (d.getMonth() === viewMonth);
        const key = toKey(d);

        const cell = document.createElement("div");
        cell.className = "cell";
        if(!inMonth) cell.classList.add("muted");
        if(key === selectedDateKey) cell.classList.add("selected");

        const holiObj = getHolidayObj(key);
        if(holiObj) cell.classList.add("holidayCell");

        const top = document.createElement("div");
        top.className = "daynum";

        const left = document.createElement("div");
        left.textContent = d.getDate();

        // ê³µíœ´ì¼ ìš°ì„  ìƒ‰ìƒ
        if(holiObj){
          left.classList.add("holidayNum");
        } else {
          if (d.getDay() === 0) left.classList.add("sunNum");
          if (d.getDay() === 6) left.classList.add("satNum");
        }

        if(isSameDay(d, today)){
          const dot = document.createElement("span");
          dot.className = "todayDot";
          left.appendChild(dot);
        }
        top.appendChild(left);

        const c = countTodos(key);
        if(c > 0){
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = `${c}`;
          top.appendChild(badge);
        } else {
          const spacer = document.createElement("span");
          spacer.style.width = "0px";
          top.appendChild(spacer);
        }

        cell.appendChild(top);

        // ê³µíœ´ì¼ ì´ë¦„ + ëŒ€ì²´ í‘œì‹œ
        if(holiObj){
          const line = document.createElement("div");
          line.className = "holidayLine";

          const hn = document.createElement("div");
          hn.className = "holidayName";
          hn.textContent = holiObj.name;

          line.appendChild(hn);

          if(holiObj.isSub){
            const tag = document.createElement("span");
            tag.className = "subTag";
            tag.textContent = "ëŒ€ì²´";
            line.appendChild(tag);
          }

          cell.appendChild(line);
        }

        cell.addEventListener("click", () => {
          selectedDateKey = key;
          if(d.getMonth() !== viewMonth || d.getFullYear() !== viewYear){
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderAllAsync();
            return;
          }
          renderAll();
          $todoInput.focus();
        });

        $calGrid.appendChild(cell);
      }
    }

    function renderTodos(){
      $selectedTitle.textContent = `ğŸ“Œ ${selectedDateKey} í•  ì¼`;

      const todos = getTodos(selectedDateKey);
      const doneCount = todos.filter(t => t.done).length;

      const holiObj = getHolidayObj(selectedDateKey);
      const holiText = holiObj
        ? ` Â· ê³µíœ´ì¼: ${escapeHtml(holiObj.name)}${holiObj.isSub ? " (ëŒ€ì²´)" : ""}`
        : "";

      $selectedMeta.innerHTML = `ì´ ${todos.length}ê°œ Â· ì™„ë£Œ ${doneCount}ê°œ (ë¡œì»¬ ì €ì¥ë¨)` +
        (holiText ? ` <span class="holidayTag">${holiText}</span>` : "");

      $todoList.innerHTML = "";
      $todoEmpty.style.display = (todos.length === 0) ? "block" : "none";

      for(const t of todos){
        const li = document.createElement("li");
        if(t.done) li.classList.add("done");

        const left = document.createElement("div");
        left.className = "left";

        const ck = document.createElement("input");
        ck.type = "checkbox";
        ck.className = "check";
        ck.checked = !!t.done;
        ck.addEventListener("change", () => {
          t.done = ck.checked;
          setTodos(selectedDateKey, todos);
          renderTodos();
        });

        const txt = document.createElement("div");
        txt.className = "txt";
        txt.textContent = t.text;

        left.appendChild(ck);
        left.appendChild(txt);

        const del = document.createElement("button");
        del.className = "del";
        del.textContent = "ì‚­ì œ";
        del.addEventListener("click", () => {
          const next = todos.filter(x => x.id !== t.id);
          setTodos(selectedDateKey, next);
          renderTodos();
          renderCalendar();
        });

        li.appendChild(left);
        li.appendChild(del);
        $todoList.appendChild(li);
      }
    }

    function addTodo(){
      const text = ($todoInput.value || "").trim();
      if(!text) return;

      const todos = getTodos(selectedDateKey);
      todos.unshift({
        id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
        text,
        done: false,
        createdAt: Date.now()
      });

      setTodos(selectedDateKey, todos);
      $todoInput.value = "";
      renderTodos();
      renderCalendar();
    }

    function clearDone(){
      const todos = getTodos(selectedDateKey);
      const next = todos.filter(t => !t.done);
      setTodos(selectedDateKey, next);
      renderTodos();
      renderCalendar();
    }

    function renderAll(){
      renderCalendar();
      renderTodos();
    }

    async function renderAllAsync(){
      const y1 = viewYear;
      const y2 = Number(selectedDateKey.slice(0,4));
      await ensureHolidaysForYear(y1);
      if(y2 !== y1) await ensureHolidaysForYear(y2);
      renderAll();
      $todoInput.focus();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // Navigation
    $prevBtn.addEventListener("click", async () => {
      const d = new Date(viewYear, viewMonth - 1, 1);
      viewYear = d.getFullYear();
      viewMonth = d.getMonth();
      await ensureHolidaysForYear(viewYear);
      renderCalendar();
    });
    $nextBtn.addEventListener("click", async () => {
      const d = new Date(viewYear, viewMonth + 1, 1);
      viewYear = d.getFullYear();
      viewMonth = d.getMonth();
      await ensureHolidaysForYear(viewYear);
      renderCalendar();
    });
    $todayBtn.addEventListener("click", async () => {
      viewYear = today.getFullYear();
      viewMonth = today.getMonth();
      selectedDateKey = toKey(today);
      await renderAllAsync();
    });

    // Todo actions
    $addBtn.addEventListener("click", addTodo);
    $todoInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addTodo();
    });
    $clearDoneBtn.addEventListener("click", clearDone);

    // Init
    todoLoad();
    holidayLoadCache();
    (async () => {
      await ensureHolidaysForYear(viewYear);
      renderAll();
    })();
  </script>
</body>
</html>
